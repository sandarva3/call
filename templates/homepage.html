<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Voice Call App</title>
</head>

<body>
    <h2>Online Users:</h2>
    {% if users %}
    {% for user in users %}
    {% if user != request.user %}
    <p>
        {{ user.username }}, Id: {{ user.id }}
        <button onclick="startCall({{ user.id }})">Call</button>
    </p>
    {% endif %}
    {% endfor %}
    {% endif %}

    <h2>Call Status:</h2>
    <div id="call-status"></div>
    <button id="end-call" style="display: none;" onclick="endCall()">End Call</button>




    <script>
        const ws = new WebSocket('ws://' + window.location.host + '/ws/signaling/');
        let localStream;
        let peerConnection;
        let currentCalleeId = null;

        // Configure ICE servers
        const configuration = {
            iceServers: [
                { urls: 'stun:stun.l.google.com:19302' }
            ]
        };


        ws.onmessage = async (event) => {
            const data = JSON.parse(event.data);

            if (data.sdp) {
                await peerConnection.setRemoteDescription(new RTCSessionDescription(data.sdp));

                if (data.sdp.type === 'offer') {
                    const answer = await peerConnection.createAnswer();
                    await peerConnection.setLocalDescription(answer);

                    ws.send(JSON.stringify({
                        sdp: offer,
                        calleeID: calleeId,
                        callerID: {{ request.user.id }},
            }));
        }
    }

        if (data.iceCandidate) {
            try {
                await peerConnection.addIceCandidate(new RTCIceCandidate(data.iceCandidate));
            } catch (e) {
                console.error('Error adding received ICE candidate:', e);
            }
        }
};


        async function startCall(calleeId) {
            try {
                document.getElementById('call-status').textContent = 'Getting microphone access...';
                localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                currentCalleeId = calleeId;

                peerConnection = new RTCPeerConnection(configuration);
                localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));

                peerConnection.ontrack = (event) => {
                    const remoteAudio = new Audio();
                    remoteAudio.srcObject = event.streams[0];
                    remoteAudio.play();
                    document.getElementById('call-status').textContent = 'Connected - In Call';
                };

                peerConnection.onicecandidate = (event) => {
                    if (event.candidate) {
                        ws.send(JSON.stringify({
                            iceCandidate: event.candidate,
                            calleeID: calleeId,
                        }));
                    }
                };

                const offer = await peerConnection.createOffer();
                await peerConnection.setLocalDescription(offer);

                ws.send(JSON.stringify({
                    sdp: offer,
                    calleeID: calleeId,
                    callerID: {{ request.user.id }},
        }));


        document.getElementById('call-status').textContent = 'Calling...';
        document.getElementById('end-call').style.display = 'block';
            } catch (error) {
            console.error('Error in startCall:', error);
            document.getElementById('call-status').textContent = 'Error: ' + error.message;
        }
        }

        async function receiveCall(data) {
            try {
                if (!peerConnection) {
                    localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    peerConnection = new RTCPeerConnection(configuration);
                    localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));

                    peerConnection.ontrack = (event) => {
                        const remoteAudio = new Audio();
                        remoteAudio.srcObject = event.streams[0];
                        remoteAudio.play();
                        document.getElementById('call-status').textContent = 'Connected - In Call';
                    };

                    peerConnection.onicecandidate = (event) => {
                        if (event.candidate) {
                            ws.send(JSON.stringify({
                                iceCandidate: event.candidate,
                                calleeID: data.callerID,
                            }));
                        }
                    };
                }

                if (data.sdp) {
                    await peerConnection.setRemoteDescription(new RTCSessionDescription(data.sdp));

                    if (data.sdp.type === 'offer') {
                        const answer = await peerConnection.createAnswer();
                        await peerConnection.setLocalDescription(answer);

                        ws.send(JSON.stringify({
                            sdp: answer,
                            calleeID: data.callerID,
                            callerID: {{ request.user.id }},
                }));

            }
                }

        if (data.iceCandidate) {
            await peerConnection.addIceCandidate(new RTCIceCandidate(data.iceCandidate));
        }

        document.getElementById('end-call').style.display = 'block';
            } catch (error) {
            console.error('Error in receiveCall:', error);
            document.getElementById('call-status').textContent = 'Error: ' + error.message;
        }
        }

        function endCall() {
            if (peerConnection) {
                peerConnection.close();
                peerConnection = null;
            }
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
                localStream = null;
            }
            document.getElementById('call-status').textContent = 'Call Ended';
            document.getElementById('end-call').style.display = 'none';
            currentCalleeId = null;
        }
    </script>



</body>

</html>